pipeline {
    agent any
    
    environment {
        PYTHON_VERSION = '3'
        VENV_DIR = 'venv'
        REPO_URL = 'https://github.com/assafNW/Devops-CI-CD-Exercise.git'
        EMAIL_AUTHOR = "assaf.naaman.work@gmail.com"
        JIRA_JENKINS_USER = "712020:10dea211-8b58-46e4-aaca-6e942f7d405e"
        JIRA_ASIGNEE_USER = "712020:8075411c-abf1-445b-b14e-3d659e5c8923"
    }
    
    stages {
        stage('Checkout Source Code') {
            steps {
                echo "Cloning repository from GitHub..."
                git branch: 'main', url: "${REPO_URL}"
                sh 'ls'
            }
        }

        stage('Setup Environment') {
            steps {
                script {
                    sh 'echo "Setting up Python environment"'
                    sh 'apt install -y python3 python3-venv python3-pip'
                    sh 'python${PYTHON_VERSION} -m venv ${VENV_DIR}'
                    sh '. ${VENV_DIR}/bin/activate && pip install --upgrade pip'
                    sh '. ${VENV_DIR}/bin/activate && pip install -r requirements.txt'
                }
            }
        }

        stage('Lint Code') {
            steps {
                script {
                    sh '. ${VENV_DIR}/bin/activate && flake8 app/ --output-file=reports/flake8.txt || true'
                    sh '. ${VENV_DIR}/bin/activate && pylint app/ --output=reports/pylint.txt || true'
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'reports/*.txt', allowEmptyArchive: true
                }
            }
        }
        
        stage('Unit Tests') {
            steps {
                script {
                    sh 'mkdir -p reports'
                    sh '. ${VENV_DIR}/bin/activate && pytest tests/unit/ -v --cov=app --cov-report=xml --cov-report=html --junit-xml=reports/unit-tests.xml'
                }
            }
            post {
                always {
                    junit 'reports/unit-tests.xml'
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'htmlcov',
                        reportFiles: 'index.html',
                        reportName: 'Unit Test Coverage Report'
                    ])
                    archiveArtifacts artifacts: 'htmlcov/**/*', allowEmptyArchive: false
                }
            }
        }
        
        stage('Integration Tests') {
            steps {
                script {
                    sh '. ${VENV_DIR}/bin/activate && pytest tests/integration/ -v --cov=app --cov-report=xml --cov-report=html --junit-xml=reports/integration-tests.xml'
                }
            }
            post {
                always {
                    junit 'reports/integration-tests.xml'
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'htmlcov',
                        reportFiles: 'index.html',
                        reportName: 'Integration Tests Coverage Report'
                    ])
                    archiveArtifacts artifacts: 'htmlcov/**/*', allowEmptyArchive: false
                }
            }
        }
        
        stage('End-to-End Tests') {
            steps {
                script {
                    sh '''
                        . ${VENV_DIR}/bin/activate
                        export DISPLAY=:99
                        Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
                        sleep 3
                        pytest tests/e2e/ -v --cov=app --cov-report=xml --cov-report=html --junit-xml=reports/e2e-tests.xml
                        killall Xvfb || true
                    '''
                }
            }
            post {
                always {
                    junit 'reports/e2e-tests.xml'
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'htmlcov',
                        reportFiles: 'index.html',
                        reportName: 'E2E Tests Coverage Report'
                    ])
                    archiveArtifacts artifacts: 'htmlcov/**/*', allowEmptyArchive: false
                }
            }
        }
        
        // stage('Performance Tests') {
            
        //     steps {
        //         script {
        //             sh '''
        //                 . ${VENV_DIR}/bin/activate
                        
        //                 python main.py &
        //                 APP_PID=$!
        //                 sleep 5
                        
        //                 locust -f tests/performance/locustfile.py \\
        //                     --headless \\
        //                     --users 10 \\
        //                     --spawn-rate 2 \\
        //                     --run-time 30s \\
        //                     --host http://localhost:5000 \\
        //                     --html reports/performance-report.html
                        
        //                 kill $APP_PID || true
        //             '''
        //         }
        //     }
        //     post {
        //         always {
        //             publishHTML([
        //                 allowMissing: false,
        //                 alwaysLinkToLastBuild: true,
        //                 keepAll: true,
        //                 reportDir: 'reports',
        //                 reportFiles: 'performance-report.html',
        //                 reportName: 'Performance Test Report'
        //             ])
        //         }
        //     }
        // }
        
        stage('Build Docker Image') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(credentialsId: 'dockerhub-cred', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS'),
                        usernamePassword(credentialsId: 'github-token', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_TOKEN')
                    ]) {
                        sh """
                            git config --global user.name "jenkins-local"
                            git config --global user.email "jenkins-local@gmail.com"
                            git remote set-url origin https://${GIT_USER}:${GIT_TOKEN}@github.com/assafNW/Devops-CI-CD-Exercise.git
                            git fetch --tags
                        """
                        def latestTag = sh(
                            script: "git tag --sort=-v:refname | grep -Eo 'v[0-9]+\\.[0-9]+\\.[0-9]+' | head -n1",
                            returnStdout: true
                        ).trim()

                        echo "Current version: ${latestTag}"
                        def newVersion
                        if (latestTag == '') {
                            newVersion = 'v1.0.0'
                        }
                        else {
                            def parts = latestTag.replace('v','').tokenize('.')
                            def major = parts[0].toInteger()
                            def minor = parts[1].toInteger()
                            def patch = parts[2].toInteger()
                            if (patch == 9){
                                patch = 0
                                minor = 1
                            }
                            else {
                                patch += 1
                            }
                            newVersion = "v${major}.${minor}.${patch}"
                        }
                        
                        echo "New version: ${newVersion}"

                        echo "---------------------------------------"
                        echo "   New Release Version: ${newVersion}"
                        echo "---------------------------------------"

                        sh """
                            echo \$DOCKER_PASS | docker login -u \$DOCKER_USER --password-stdin
                            echo "Building ${newVersion}..."

                            docker build -f docker/dockerfile -t assafnw/devops-ci-cd-dev:${newVersion} .
                            docker tag assafnw/devops-ci-cd-dev:${newVersion} assafnw/devops-ci-cd-dev:latest
                            
                            echo "Pushing Docker images..."
                            docker push assafnw/devops-ci-cd-dev:${newVersion}
                            docker push assafnw/devops-ci-cd-dev:latest
                            
                            docker logout
                        """

                        echo "Pushing new tag to GitHub..."
                        
                        sh """
                            git tag -a ${newVersion} -m "jenkins-local: Build: ${env.JOB_NAME} - ${env.BUILD_NUMBER}"
                            git push origin ${newVersion}
                        """
                    }
                }
            }
        }
        
        stage('Deploy to Staging') {
            when {
                branch 'develop'
            }
            steps {
                script {
                    sh '''
                        echo "Deploying to staging environment"
                        docker stop staging-app || true
                        docker rm staging-app || true
                        docker run -d --name staging-app -p 5001:5000 devops-testing-app:${BUILD_NUMBER}
                        
                        sleep 5
                        curl -f http://localhost:5001/health || exit 1
                    '''
                }
            }
        }
    }
    
    post {
        always {
            cleanWs()
        }
        success {
            script {
                sh 'echo "Pipeline completed successfully!"'
                emailext (
                    subject: "✅ Pipeline Success: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                    body: """
                        <p>The pipeline completed successfully!</p>
                        <ul>
                            <li><strong>Build:</strong> ${env.BUILD_NUMBER}</li>
                            <li><strong>Branch:</strong> ${env.BRANCH_NAME}</li>
                            <li><strong>Duration:</strong> ${currentBuild.durationString}</li>
                            <li><strong>Reports:</strong> Check the artifacts section</li>
                        </ul>
                        <p><a href="${env.BUILD_URL}">View Build Details</a></p>
                    """,
                    to: "${env.EMAIL_AUTHOR}"
                )
            }
        }
        failure {
            script {
                sh 'echo "Pipeline failed!"'
                sh 'echo "Sending email upon failure..."'
                emailext (
                    subject: "❌ Pipeline Failure: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                    body: """
                        <p>The pipeline failed!</p>
                        <ul>
                            <li><strong>Build:</strong> ${env.BUILD_NUMBER}</li>
                            <li><strong>Branch:</strong> ${env.BRANCH_NAME}</li>
                            <li><strong>Duration:</strong> ${currentBuild.durationString}</li>
                            <li><strong>Failed Stage:</strong> ${currentBuild.currentResult}</li>
                        </ul>
                        <p><a href="${env.BUILD_URL}">View Build Details</a></p>
                    """,
                    to: "${env.EMAIL_AUTHOR}"
                )
            }

            echo "Opening a bug ticket on JIRA..."
            script{
                def bugIssue = [
                    fields: [
                        project: [
                            key: 'CICDEX'
                        ],
                        summary: "Development pipline failed! Build: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                        description: """
                        Build: ${env.JOB_NAME} - ${env.BUILD_NUMBER}, 
                        Branch: ${env.BRANCH_NAME}, 
                        Duration: ${currentBuild.durationString}, 
                        Failed Stage: ${currentBuild.currentResult}, 
                        View Build Details Here: ${env.BUILD_URL}
                        """,
                        issuetype: [
                            name: 'Bug'
                        ],
                        reporter: [
                            id: "${env.JIRA_JENKINS_USER}"
                        ],
                        // This sets who the bug is assigned to
                        assignee: [
                            id: "${env.JIRA_ASIGNEE_USER}"
                        ]
                    ]
                ]
                // Creates the issue and return the ID
                def response = jiraNewIssue issue: bugIssue, site: 'assaf-devops'
                echo "Bug ticket created on JIRA: ${response.data.key}"
            }
        }
    }
}